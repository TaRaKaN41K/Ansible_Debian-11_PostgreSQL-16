# Setting up Debian 11 and PostgreSQL 16 via Ansible playbook

Этот плейбук Ansible автоматизирует развертывание и настройку системы на сервере с Debian 11.

Перед запуском playbook  разрешим подключения по ssh для root пользователя:

В конфигурационном файле ssh сервера:

```bash
nano /etc/ssh/sshd_config
```

поменяем строки:

```bash
PermitRootLogin yes
PasswordAuthentication yes
```

После этого перезапустим ssh сервер:

```bash
systemctl restart sshd
```
После этого можно запускать playbook:

```bash
ansible-playbook -i inventory.ini debian_11_psql_configuration.yml
```

# Описание

## `inventory.ini`
Это файл с хостами. В нём находятся 2 хоста:

`debian_11_primary` - это наш сервер на Debian 11. Мы подключаемся к нему через root пользователя для установки и настройки sudo (так как изначально, при установке "ванильного" Debian 11 нет sudo, его нужно будет установить при помощи Ansible) и статической настройки адреса.

`debian_11_secondary` - это тот же сервер на Debian 11, но подключаемся мы по новому адресу и за нового (созданного ранее) пользователя.

**!!!Сам файл `inventory.ini` не прикреплён из-за соображений безопасности, вместо него `inventory.ini.example`, в котором отображена структура и пример данных.**

## `vars.yml`
Это файл с переменными, которые используются непосредственно в playbook.

**!!!Сам файл `vars.yml` не прикреплён из-за соображений безопасности, вместо него `vars.yml.example`, в котором отображена структура и пример данных.**

## `debian_11_psql_configuration.yml`
Это файл playbook

Он выполняет следующие задачи:

### 1. **Установка необходимых пакетов, создание пользователя и настройка статического IP-адреса** на сервере `Debian 11` под root пользователем

   - **Обновление списка пакетов**: Обновляет кэш APT, чтобы получить информацию о последних версиях пакетов.
   - **Установка пакетов**: Устанавливает утилиты, необходимые для работы системы, включая `sudo`, `iptables`, `iptables-persistent`, `rsyslog`, `curl`, `ca-certificates`, и `python3-psycopg2`.
   - **Создание пользователя и настройка прав**:
      - Создает нового пользователя с правами администратора, добавляет его в группу `sudo`, и настраивает `sudo` для этого пользователя без запроса пароля.
   - **Настройка сетевых интерфейсов**:
      - Задает статический IP-адрес для интерфейса `enp2s0` и указывает шлюз и DNS-серверы.
      - Перезапускает сетевой сервис, чтобы применить изменения.

### 2. **Генерация SSH-ключа на локальной машине и передача на сервер**

   - **Проверка существования SSH-ключа**: Проверяет, существует ли SSH-ключ на локальной машине.
   - **Удаление существующего SSH-ключа**: Удаляет существующий ключ, если он есть.
   - **Генерация нового SSH-ключа**: Создает новый ключ RSA с указанной длиной и фразой-паролем.
   - **Передача публичного ключа на сервер**: Использует команду `ssh-copy-id` для передачи публичного ключа на сервер `Debian 11`, чтобы обеспечить доступ по SSH.

### 3. **Настройка сервера `Debian 11` (за нового пользователя)**

   - **Обновление списка пакетов**: Обновляет кэш APT.
   - **Настройка SSH**:
      - Включает аутентификацию по паролю и открытым ключам.
      - Указывает место хранения открытого ключа
      - Запрецает доступ по ssh для root пользователя
      - Ограничивает доступ по SSH только для нового пользователя.
      - Устанавливает пользовательский порт SSH, указанный в переменных.
      - Настраивает SSH на прослушивание только указанного IP-адреса.
      - Перезапускает службу SSH для применения изменений.
   - **Настройка фаервола (iptables)**:
      - Очищает существующие правила.
      - Разрешает установленные подключения и подключение к новому порту SSH.
      - Разрешает подключение к порту сервера PostgreSQL.
      - Настраивает логирование входящих пакетов и запрещает все остальные входящие подключения.
      - Сохраняет правила iptables.
   - **Настройка rsyslog для логирования iptables**:
      - Создает директорию `/etc/rsyslog.d`, если её не существует.
      - Создает файл для логов iptables - `/var/log/iptables.log`
      - Создает конфигурацию в файле `/etc/rsyslog.d/iptables.conf` для логирования правил iptables в файл `/var/log/iptables.log`.
      - Перезапускает службу rsyslog.
   - **Установка и настройка PostgreSQL 16**:
      - Добавляет репозиторий PostgreSQL, загружает его ключ и устанавливает PostgreSQL версии 16.
      - Указывает файл для логирования.
      - Настраивает PostgreSQL на прослушивание на всех IP-адресах, задает порт для подключения, настраивает удаленный доступ и перезапускает службу для применения изменений.
      - Устанавливает пароль для пользователя PostgreSQL.
      - Перезапускает службу для применения изменений.

### 4. **Перезагрузка сервера**

   - Завершающий шаг — перезагрузка сервера `Debian 11`, чтобы убедиться, что все изменения вступили в силу.
     - Посылается сигнал перезагрузки.
     - Завершается выполнение playbook.
